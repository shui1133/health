<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂居家呼吸照護所 - 系統管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-tab { border-bottom: 4px solid #2563eb; color: #2563eb; }
        .loading { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<div id="loading" class="loading flex-col">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-2"></div>
    <p>資料處理中...</p>
</div>

<nav class="bg-white shadow-md p-4">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold text-blue-800">百樂管理後台</h1>
        <div class="space-x-4">
            <button onclick="switchTab('faq')" id="tab-faq" class="px-4 py-2 font-medium active-tab">FAQ 管理</button>
            <button onclick="switchTab('class')" id="tab-class" class="px-4 py-2 font-medium">分類管理</button>
        </div>
    </div>
</nav>

<main class="max-w-6xl mx-auto p-6">
    <!-- FAQ 管理區 -->
    <div id="section-faq">
        <div class="flex flex-wrap gap-4 mb-6 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700">匯入 CSV</label>
                <input type="file" id="csvFile" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 border rounded p-1">
            </div>
            <button onclick="importCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">匯入資料</button>
            <button onclick="addNewFAQ()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ 新增問題</button>
            <button onclick="saveToGitHub('FAQ.csv', faqData)" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">儲存至 GitHub</button>
        </div>

        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 border">項次</th>
                        <th class="p-3 border">分類</th>
                        <th class="p-3 border">問題說明</th>
                        <th class="p-3 border">答案內容</th>
                        <th class="p-3 border">操作</th>
                    </tr>
                </thead>
                <tbody id="faqTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- 分類管理區 -->
    <div id="section-class" class="hidden">
        <div class="flex gap-4 mb-6 items-end">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700">新增分類名稱</label>
                <input type="text" id="newClassName" class="mt-1 block w-full border rounded p-2" placeholder="例如：補助流程">
            </div>
            <button onclick="addClass()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">新增分類</button>
            <button onclick="saveToGitHub('class.csv', classData, true)" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">儲存分類至 GitHub</button>
        </div>

        <div class="bg-white rounded-lg shadow max-w-md">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 border">分類名稱</th>
                        <th class="p-3 border">操作</th>
                    </tr>
                </thead>
                <tbody id="classTableBody"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    const GITHUB_CONFIG = {
        token: "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",
        owner: "shui1133",
        repo: "health"
    };

    let faqData = [];
    let classData = [];

    // 初始化載入
    window.onload = async () => {
        await loadInitialData();
        renderFAQ();
        renderClass();
    };

    async function loadInitialData() {
        showLoading(true);
        try {
            faqData = await fetchFromGitHub('FAQ.csv') || [];
            classData = await fetchFromGitHub('class.csv', true) || [];
        } catch (e) {
            console.error("載入失敗", e);
        }
        showLoading(false);
    }

    function switchTab(tab) {
        document.getElementById('section-faq').classList.toggle('hidden', tab !== 'faq');
        document.getElementById('section-class').classList.toggle('hidden', tab !== 'class');
        document.getElementById('tab-faq').className = `px-4 py-2 font-medium ${tab === 'faq' ? 'active-tab' : ''}`;
        document.getElementById('tab-class').className = `px-4 py-2 font-medium ${tab === 'class' ? 'active-tab' : ''}`;
    }

    function renderFAQ() {
        const body = document.getElementById('faqTableBody');
        body.innerHTML = faqData.map((item, idx) => `
            <tr>
                <td class="p-3 border">${idx + 1}</td>
                <td class="p-3 border">
                    <select onchange="updateFAQ(${idx}, 'category', this.value)" class="border p-1 rounded">
                        ${classData.map(c => `<option value="${c}" ${c === item.category ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </td>
                <td class="p-3 border"><input type="text" value="${item.question}" onchange="updateFAQ(${idx}, 'question', this.value)" class="w-full border p-1 rounded"></td>
                <td class="p-3 border"><textarea onchange="updateFAQ(${idx}, 'answer', this.value)" class="w-full border p-1 rounded text-sm h-12">${item.answer}</textarea></td>
                <td class="p-3 border text-center">
                    <button onclick="deleteFAQ(${idx})" class="text-red-600 hover:underline">刪除</button>
                </td>
            </tr>
        `).join('');
    }

    function renderClass() {
        const body = document.getElementById('classTableBody');
        body.innerHTML = classData.map((name, idx) => `
            <tr>
                <td class="p-3 border">
                    <input type="text" value="${name}" onchange="updateClass(${idx}, this.value)" class="w-full border p-1 rounded">
                </td>
                <td class="p-3 border text-center">
                    <button onclick="deleteClass(${idx})" class="text-red-600 hover:underline">刪除</button>
                </td>
            </tr>
        `).join('');
    }

    // 資料操作邏輯
    function updateFAQ(idx, field, val) { faqData[idx][field] = val; }
    function deleteFAQ(idx) { if(confirm('確定刪除?')) { faqData.splice(idx, 1); renderFAQ(); } }
    function addNewFAQ() { 
        faqData.unshift({ category: classData[0] || '一般', question: '', answer: '' }); 
        renderFAQ(); 
    }
    
    function addClass() {
        const val = document.getElementById('newClassName').value.trim();
        if(val) { classData.push(val); renderClass(); document.getElementById('newClassName').value = ''; }
    }
    function updateClass(idx, val) { classData[idx] = val; renderFAQ(); }
    function deleteClass(idx) { classData.splice(idx, 1); renderClass(); renderFAQ(); }

    function importCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert('請選擇檔案');
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n');
            const newItems = lines.slice(1).filter(line => line.trim()).map(line => {
                const parts = line.split(',');
                return { category: parts[1], question: parts[2], answer: parts[3] };
            });
            faqData = [...newItems, ...faqData];
            renderFAQ();
        };
        reader.readAsText(file);
    }

    // GitHub API 連接
    async function fetchFromGitHub(path, isClass = false) {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
        const res = await fetch(url, { headers: { Authorization: `token ${GITHUB_CONFIG.token}` } });
        if(!res.ok) return [];
        const file = await res.json();
        const content = decodeURIComponent(escape(atob(file.content)));
        const rows = content.split('\n').filter(r => r.trim());
        if(isClass) return rows.slice(1);
        return rows.slice(1).map(r => {
            const p = r.split('|'); // 使用 | 避免逗號衝突
            return { category: p[1], question: p[2], answer: p[3] };
        });
    }

    async function saveToGitHub(path, data, isClass = false) {
        showLoading(true);
        let csvContent = isClass ? "name\n" + data.join('\n') : "id|category|question|answer\n" + data.map((d, i) => `${i+1}|${d.category}|${d.question}|${d.answer}`).join('\n');
        
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
        const headers = { Authorization: `token ${GITHUB_CONFIG.token}`, Accept: "application/vnd.github.v3+json" };
        
        const getFile = await fetch(url, { headers });
        let sha = "";
        if(getFile.ok) { const f = await getFile.json(); sha = f.sha; }

        const res = await fetch(url, {
            method: 'PUT',
            headers,
            body: JSON.stringify({
                message: `Update ${path}`,
                content: btoa(unescape(encodeURIComponent(csvContent))),
                sha: sha
            })
        });

        showLoading(false);
        if(res.ok) alert('儲存成功！'); else alert('儲存失敗，請檢查 Token');
    }

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
</script>
</body>
</html>
