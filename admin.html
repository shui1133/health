<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂居家呼吸照護所 - 系統管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-blue-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">百樂系統管理中心</h1>
            <div class="space-x-4">
                <button onclick="switchTab('faq')" class="hover:underline">FAQ 管理</button>
                <button onclick="switchTab('class')" class="hover:underline">分類管理</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <!-- FAQ 管理頁面 -->
        <div id="faq-section">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">FAQ 資料管理</h2>
                <div class="space-x-2 mt-4 md:mt-0">
                    <input type="file" id="csv-upload" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                    <button onclick="document.getElementById('csv-upload').click()" class="bg-green-600 text-white px-4 py-2 rounded shadow">匯入 CSV</button>
                    <button onclick="addNewFAQ()" class="bg-blue-600 text-white px-4 py-2 rounded shadow">+ 新增問題</button>
                    <button onclick="saveToGitHub('FAQ.csv', faqData)" class="bg-red-600 text-white px-4 py-2 rounded shadow">儲存至 GitHub</button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-3">項次</th>
                            <th class="p-3">分類</th>
                            <th class="p-3">問題說明</th>
                            <th class="p-3">答案內容</th>
                            <th class="p-3">操作</th>
                        </tr>
                    </thead>
                    <tbody id="faq-table-body">
                        <!-- 資料動態插入 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 分類管理頁面 -->
        <div id="class-section" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">分類欄位管理</h2>
                <button onclick="saveToGitHub('class.csv', classData)" class="bg-red-600 text-white px-4 py-2 rounded shadow">儲存分類至 GitHub</button>
            </div>
            <div class="max-w-md bg-white p-6 rounded-lg shadow">
                <div class="flex mb-4">
                    <input type="text" id="new-class-input" placeholder="輸入新分類名稱" class="border p-2 flex-grow rounded-l">
                    <button onclick="addClass()" class="bg-blue-600 text-white px-4 py-2 rounded-r">新增</button>
                </div>
                <ul id="class-list" class="divide-y">
                    <!-- 分類動態插入 -->
                </ul>
            </div>
        </div>
    </main>

    <!-- 編輯彈窗 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-4">編輯 FAQ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">分類</label>
                    <select id="edit-class" class="w-full border p-2 rounded"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">問題說明</label>
                    <input type="text" id="edit-question" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium">答案內容</label>
                    <textarea id="edit-answer" rows="6" class="w-full border p-2 rounded"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeModal()" class="text-gray-600 px-4 py-2">取消</button>
                <button id="save-btn" class="bg-blue-600 text-white px-6 py-2 rounded">暫存修改</button>
            </div>
        </div>
    </div>

    <script>
        // 設定區
        const GITHUB_CONFIG = {
            owner: 'shui1133',
            repo: 'health',
            token: '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'
        };

        let faqData = [];
        let classData = [];
        let currentEditIndex = -1;

        // 初始化
        window.onload = async () => {
            await loadFromGitHub('class.csv');
            await loadFromGitHub('FAQ.csv');
        };

        function switchTab(tab) {
            document.getElementById('faq-section').classList.toggle('hidden', tab !== 'faq');
            document.getElementById('class-section').classList.toggle('hidden', tab !== 'class');
            if(tab === 'class') renderClassList();
        }

        // 從 GitHub 讀取
        async function loadFromGitHub(filename) {
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }
                });
                if (!res.ok) throw new Error('檔案不存在');
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                
                if(filename === 'FAQ.csv') {
                    parseFAQCSV(content);
                } else {
                    classData = content.split('\n').filter(line => line.trim() !== '');
                    renderClassList();
                }
            } catch (err) {
                console.log(filename + " 載入失敗或為空檔案");
            }
        }

        // 解析 CSV (簡單版)
        function parseFAQCSV(text) {
            const lines = text.split('\n');
            faqData = lines.slice(1).filter(l => l.trim() !== '').map((line, idx) => {
                const parts = line.split(',');
                return {
                    id: parts[0],
                    category: parts[1],
                    question: parts[2],
                    answer: parts.slice(3).join(',').replace(/^"|"$/g, '')
                };
            });
            renderFAQTable();
        }

        function renderFAQTable() {
            const tbody = document.getElementById('faq-table-body');
            tbody.innerHTML = faqData.map((item, index) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${item.id}</td>
                    <td class="p-3">${item.category}</td>
                    <td class="p-3 font-medium">${item.question}</td>
                    <td class="p-3 text-sm text-gray-600 truncate max-w-xs">${item.answer}</td>
                    <td class="p-3">
                        <button onclick="editFAQ(${index})" class="text-blue-600 mr-2">修改</button>
                        <button onclick="deleteFAQ(${index})" class="text-red-600">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderClassList() {
            const list = document.getElementById('class-list');
            list.innerHTML = classData.map((cls, index) => `
                <li class="flex justify-between items-center py-2">
                    <span>${cls}</span>
                    <button onclick="deleteClass(${index})" class="text-red-500 text-sm">刪除</button>
                </li>
            `).join('');
            
            // 更新編輯視窗的下拉選單
            const select = document.getElementById('edit-class');
            select.innerHTML = classData.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // 增刪查改功能
        function addNewFAQ() {
            currentEditIndex = -1;
            document.getElementById('modal-title').innerText = '新增 FAQ';
            document.getElementById('edit-question').value = '';
            document.getElementById('edit-answer').value = '';
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('save-btn').onclick = confirmSaveFAQ;
        }

        function editFAQ(index) {
            currentEditIndex = index;
            const item = faqData[index];
            document.getElementById('modal-title').innerText = '編輯 FAQ';
            document.getElementById('edit-class').value = item.category;
            document.getElementById('edit-question').value = item.question;
            document.getElementById('edit-answer').value = item.answer;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('save-btn').onclick = confirmSaveFAQ;
        }

        function confirmSaveFAQ() {
            const newItem = {
                id: currentEditIndex === -1 ? faqData.length + 1 : faqData[currentEditIndex].id,
                category: document.getElementById('edit-class').value,
                question: document.getElementById('edit-question').value,
                answer: document.getElementById('edit-answer').value
            };

            if(currentEditIndex === -1) {
                faqData.push(newItem);
            } else {
                faqData[currentEditIndex] = newItem;
            }
            renderFAQTable();
            closeModal();
        }

        function deleteFAQ(index) {
            if(confirm('確定刪除此題嗎？')) {
                faqData.splice(index, 1);
                renderFAQTable();
            }
        }

        function addClass() {
            const val = document.getElementById('new-class-input').value.trim();
            if(val && !classData.includes(val)) {
                classData.push(val);
                document.getElementById('new-class-input').value = '';
                renderClassList();
            }
        }

        function deleteClass(index) {
            classData.splice(index, 1);
            renderClassList();
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // CSV 處理與 GitHub 儲存
        async function saveToGitHub(filename, dataArray) {
            let csvContent = "";
            if(filename === 'FAQ.csv') {
                csvContent = "項次,分類,問題說明,答案內容\n" + 
                    dataArray.map(item => `${item.id},${item.category},${item.question},"${item.answer.replace(/"/g, '""')}"`).join('\n');
            } else {
                csvContent = dataArray.join('\n');
            }

            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filename}`;
                
                // 必須先獲取最新的 SHA 才能更新
                const currentFileRes = await fetch(url, {
                    headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }
                });
                let sha = "";
                if(currentFileRes.ok) {
                    const fileData = await currentFileRes.json();
                    sha = fileData.sha;
                }

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${filename}`,
                        content: btoa(unescape(encodeURIComponent(csvContent))),
                        sha: sha || undefined
                    })
                });

                if(res.ok) alert(`${filename} 已成功同步至 GitHub！`);
                else throw new Error('上傳失敗');
            } catch (err) {
                alert('儲存失敗：' + err.message);
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => parseFAQCSV(event.target.result);
            reader.readAsText(file);
        }
    </script>
</body>
</html>