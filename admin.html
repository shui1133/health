<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呼吸治療診所 - FAQ 系統管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="loader" class="loading-overlay">處理中，請稍候...</div>

    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">呼吸治療 FAQ 管理系統</h1>
            <div class="space-x-2">
                <button onclick="saveAllToGitHub()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded text-sm">儲存至 GitHub</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 lg:p-8">
        <!-- 分類管理區 -->
        <section class="mb-8 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2">分類管理</h2>
            <div class="flex flex-wrap gap-2 mb-4" id="categoryContainer">
                <!-- Categories will appear here -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="newCategory" placeholder="新分類名稱" class="border p-2 rounded flex-1">
                <button onclick="addCategory()" class="bg-blue-500 text-white px-4 py-2 rounded">新增分類</button>
            </div>
        </section>

        <!-- FAQ 管理區 -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-semibold">FAQ 內容管理</h2>
                <div class="flex gap-2">
                    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="importCSV(this)">
                    <button onclick="document.getElementById('csvInput').click()" class="text-blue-600 border border-blue-600 px-3 py-1 rounded text-sm">匯入 CSV</button>
                    <button onclick="openModal()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ 新增 FAQ</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-3 border">項次</th>
                            <th class="p-3 border">分類</th>
                            <th class="p-3 border">問題說明</th>
                            <th class="p-3 border">答案內容</th>
                            <th class="p-3 border">操作</th>
                        </tr>
                    </thead>
                    <tbody id="faqTableBody">
                        <!-- FAQ Data -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Edit Modal -->
    <div id="faqModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">新增/修改 FAQ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">分類</label>
                    <select id="editCategory" class="w-full border p-2 rounded"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">問題說明</label>
                    <input type="text" id="editQuestion" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium">答案內容</label>
                    <textarea id="editAnswer" rows="6" class="w-full border p-2 rounded"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 border rounded">取消</button>
                <button onclick="saveFAQ()" class="px-4 py-2 bg-blue-600 text-white rounded">確認儲存</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            username: 'shui1133',
            repo: 'health',
            token: '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',
            faqPath: 'FAQ.csv',
            classPath: 'class.csv'
        };

        let faqData = [];
        let categories = ["補助申請", "氧氣設備", "呼吸復健", "一般諮詢"];
        let editIndex = -1;

        // 初始化
        window.onload = () => {
            renderCategories();
            renderFAQ();
        };

        function renderCategories() {
            const container = document.getElementById('categoryContainer');
            const select = document.getElementById('editCategory');
            container.innerHTML = '';
            select.innerHTML = '';
            
            categories.forEach((cat, idx) => {
                container.innerHTML += `
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center gap-2">
                        ${cat}
                        <button onclick="deleteCategory(${idx})" class="text-red-500 font-bold">&times;</button>
                    </span>
                `;
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function addCategory() {
            const input = document.getElementById('newCategory');
            if (input.value.trim()) {
                categories.push(input.value.trim());
                input.value = '';
                renderCategories();
            }
        }

        function deleteCategory(index) {
            categories.splice(index, 1);
            renderCategories();
        }

        function renderFAQ() {
            const tbody = document.getElementById('faqTableBody');
            tbody.innerHTML = '';
            faqData.forEach((item, idx) => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 border">${idx + 1}</td>
                        <td class="p-3 border">${item.category}</td>
                        <td class="p-3 border font-medium">${item.question}</td>
                        <td class="p-3 border text-gray-600 text-sm">${item.answer.substring(0, 50)}...</td>
                        <td class="p-3 border">
                            <button onclick="openModal(${idx})" class="text-blue-600 mr-2">修改</button>
                            <button onclick="deleteFAQ(${idx})" class="text-red-600">刪除</button>
                        </td>
                    </tr>
                `;
            });
        }

        function openModal(index = -1) {
            editIndex = index;
            document.getElementById('faqModal').classList.remove('hidden');
            if (index > -1) {
                const item = faqData[index];
                document.getElementById('editCategory').value = item.category;
                document.getElementById('editQuestion').value = item.question;
                document.getElementById('editAnswer').value = item.answer;
            } else {
                document.getElementById('editQuestion').value = '';
                document.getElementById('editAnswer').value = '';
            }
        }

        function closeModal() {
            document.getElementById('faqModal').classList.add('hidden');
        }

        function saveFAQ() {
            const newItem = {
                category: document.getElementById('editCategory').value,
                question: document.getElementById('editQuestion').value,
                answer: document.getElementById('editAnswer').value
            };

            if (editIndex > -1) {
                faqData[editIndex] = newItem;
            } else {
                faqData.push(newItem);
            }
            renderFAQ();
            closeModal();
        }

        function deleteFAQ(index) {
            if (confirm('確定要刪除此項次嗎？')) {
                faqData.splice(index, 1);
                renderFAQ();
            }
        }

        function importCSV(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                const imported = rows.map(row => {
                    const cols = row.split(',');
                    if (cols.length >= 3) {
                        return { category: cols[1], question: cols[2], answer: cols[3]?.replace(/"/g, '') || '' };
                    }
                    return null;
                }).filter(i => i);
                faqData = [...faqData, ...imported];
                renderFAQ();
            };
            reader.readAsText(file);
        }

        async function saveAllToGitHub() {
            document.getElementById('loader').style.display = 'flex';
            try {
                // 1. Save FAQ.csv
                const faqCsv = "項次,分類,問題說明,答案內容\n" + 
                    faqData.map((d, i) => `${i+1},${d.category},${d.question},"${d.answer.replace(/"/g, '""')}"`).join('\n');
                await uploadToGitHub(CONFIG.faqPath, faqCsv);

                // 2. Save class.csv
                const classCsv = "分類\n" + categories.join('\n');
                await uploadToGitHub(CONFIG.classPath, classCsv);

                alert('資料已成功同步至 GitHub！');
            } catch (err) {
                console.error(err);
                alert('儲存失敗，請檢查 Token 或網路狀態。');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function uploadToGitHub(path, content) {
            const url = `https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${path}`;
            
            // 先獲取檔案 sha (如果檔案已存在)
            let sha = "";
            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `token ${CONFIG.token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                }
            } catch (e) {}

            const body = {
                message: `Update ${path} via Admin Web`,
                content: btoa(unescape(encodeURIComponent(content))),
                sha: sha || undefined
            };

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${CONFIG.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) throw new Error('GitHub API Error');
        }
    </script>
</body>
</html>