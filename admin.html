<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂管理後台 - 呼吸照護 FAQ 系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-tab { border-bottom: 4px solid #3b82f6; color: #3b82f6; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="loading" class="loading-overlay flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
        <p>處理中，請稍候...</p>
    </div>

    <!-- 導航欄 -->
    <nav class="bg-white shadow-md mb-6">
        <div class="max-w-6xl mx-auto px-4 flex justify-between items-center h-16">
            <h1 class="text-xl font-bold text-blue-700">百樂居家呼吸照護所 - 管理系統</h1>
            <div class="flex space-x-4">
                <button onclick="switchTab('faq')" id="tab-faq" class="px-3 py-2 font-medium active-tab">FAQ 管理</button>
                <button onclick="switchTab('class')" id="tab-class" class="px-3 py-2 font-medium">分類管理</button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 pb-20">
        
        <!-- FAQ 管理頁面 -->
        <section id="page-faq" class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">新增 / 編輯 FAQ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="faq-category" placeholder="分類 (例如: 補助相關)" class="border p-2 rounded">
                    <input type="text" id="faq-question" placeholder="問題說明" class="border p-2 rounded">
                    <textarea id="faq-answer" placeholder="答案內容" class="border p-2 rounded md:col-span-2 h-32"></textarea>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="addFAQ()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">加入清單</button>
                    <button onclick="saveToGithub('FAQ')" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">儲存至 GitHub (FAQ.csv)</button>
                    <label class="bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700 cursor-pointer">
                        匯入 CSV <input type="file" id="csv-upload" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                    </label>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">項次</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分類</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">問題</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="faq-list" class="bg-white divide-y divide-gray-200">
                        <!-- 動態內容 -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 分類管理頁面 -->
        <section id="page-class" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">分類項目維護</h2>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="class-input" placeholder="新分類名稱" class="border p-2 rounded flex-grow">
                    <button onclick="addClass()" class="bg-blue-600 text-white px-6 py-2 rounded">新增分類</button>
                </div>
                <button onclick="saveToGithub('class')" class="bg-green-600 text-white px-6 py-2 rounded">儲存至 GitHub (class.csv)</button>
            </div>

            <ul id="class-list" class="bg-white rounded-lg shadow-sm border border-gray-200 divide-y">
                <!-- 動態內容 -->
            </ul>
        </section>

    </main>

    <script>
        // 設定資訊
        const GITHUB_CONFIG = {
            username: 'shui1133',
            repo: 'health',
            token: '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'
        };

        let faqData = [];
        let classData = [];

        // 初始化載入
        window.onload = async () => {
            await loadFromGithub('FAQ');
            await loadFromGithub('class');
            renderFAQ();
            renderClass();
        };

        function switchTab(tab) {
            document.getElementById('page-faq').classList.toggle('hidden', tab !== 'faq');
            document.getElementById('page-class').classList.toggle('hidden', tab !== 'class');
            document.getElementById('tab-faq').classList.toggle('active-tab', tab === 'faq');
            document.getElementById('tab-class').classList.toggle('active-tab', tab === 'class');
        }

        // 資料渲染
        function renderFAQ() {
            const list = document.getElementById('faq-list');
            list.innerHTML = faqData.map((item, index) => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.category}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${item.question}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="deleteFAQ(${index})" class="text-red-600 hover:text-red-900">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderClass() {
            const list = document.getElementById('class-list');
            list.innerHTML = classData.map((c, index) => `
                <li class="p-4 flex justify-between items-center">
                    <span>${c}</span>
                    <button onclick="deleteClass(${index})" class="text-red-600 hover:text-red-900">刪除</button>
                </li>
            `).join('');
        }

        // 新增與刪除功能
        function addFAQ() {
            const cat = document.getElementById('faq-category').value;
            const q = document.getElementById('faq-question').value;
            const a = document.getElementById('faq-answer').value;
            if(!cat || !q || !a) return alert('請填寫完整資訊');
            faqData.push({ category: cat, question: q, answer: a });
            renderFAQ();
            // 清空輸入
            document.getElementById('faq-question').value = '';
            document.getElementById('faq-answer').value = '';
        }

        function deleteFAQ(index) {
            if(confirm('確定刪除？')) {
                faqData.splice(index, 1);
                renderFAQ();
            }
        }

        function addClass() {
            const val = document.getElementById('class-input').value;
            if(!val) return;
            classData.push(val);
            document.getElementById('class-input').value = '';
            renderClass();
        }

        function deleteClass(index) {
            classData.splice(index, 1);
            renderClass();
        }

        // CSV 處理
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').slice(1); // 略過標題
                lines.forEach(line => {
                    const parts = line.split(',');
                    if(parts.length >= 3) {
                        faqData.push({ category: parts[0], question: parts[1], answer: parts.slice(2).join(',') });
                    }
                });
                renderFAQ();
            };
            reader.readAsText(file);
        }

        // GitHub API 通訊
        async function saveToGithub(type) {
            document.getElementById('loading').style.display = 'flex';
            const fileName = type === 'FAQ' ? 'FAQ.csv' : 'class.csv';
            let content = '';
            
            if(type === 'FAQ') {
                content = '分類,問題,答案\n' + faqData.map(d => `"${d.category}","${d.question}","${d.answer}"`).join('\n');
            } else {
                content = '分類名稱\n' + classData.join('\n');
            }

            try {
                // 先嘗試取得檔案 SHA
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${fileName}`;
                const getRes = await fetch(url, {
                    headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }
                });
                const fileInfo = getRes.ok ? await getRes.json() : null;
                const sha = fileInfo ? fileInfo.sha : null;

                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update ${fileName} via Admin Panel`,
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha
                    })
                });

                if(putRes.ok) alert(`${fileName} 儲存成功！`);
                else alert('儲存失敗，請檢查權限或網路');
            } catch (error) {
                console.error(error);
                alert('發生錯誤');
            }
            document.getElementById('loading').style.display = 'none';
        }

        async function loadFromGithub(type) {
            const fileName = type === 'FAQ' ? 'FAQ.csv' : 'class.csv';
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${fileName}`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }
                });
                if(!res.ok) return;
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                
                if(type === 'FAQ') {
                    faqData = content.split('\n').slice(1).filter(l => l).map(l => {
                        const parts = l.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                        return {
                            category: (parts[0] || '').replace(/"/g, ''),
                            question: (parts[1] || '').replace(/"/g, ''),
                            answer: (parts[2] || '').replace(/"/g, '')
                        };
                    });
                } else {
                    classData = content.split('\n').slice(1).filter(l => l);
                }
            } catch (e) { console.error(`載入 ${fileName} 失敗`); }
        }
    </script>
</body>
</html>
