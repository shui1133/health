<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呼吸治療診所 - 系統管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-tab { border-bottom: 4px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">呼吸治療 FAQ 管理系統</h1>
            <span class="text-sm bg-blue-700 px-3 py-1 rounded">系統管理員模式</span>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8">
        <!-- 頁籤切換 -->
        <div class="flex space-x-8 mb-6 border-b">
            <button onclick="switchTab('faq')" id="tab-faq" class="pb-2 px-4 active-tab font-medium">FAQ 資料維護</button>
            <button onclick="switchTab('class')" id="tab-class" class="pb-2 px-4 font-medium text-gray-500">分類管理</button>
            <button onclick="switchTab('config')" id="tab-config" class="pb-2 px-4 font-medium text-gray-500">GitHub 設定</button>
        </div>

        <!-- GitHub 設定區塊 (Token 等) -->
        <section id="section-config" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg font-bold mb-4">GitHub API 設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="gh-token" placeholder="GitHub Personal Access Token" class="border p-2 rounded">
                <input type="text" id="gh-repo" placeholder="Owner/Repo (例如: user/my-faq-repo)" class="border p-2 rounded">
            </div>
            <p class="text-xs text-gray-500 mt-2">* 此資訊僅存於瀏覽器 LocalStorage，用於儲存 CSV 到 GitHub。</p>
        </section>

        <!-- FAQ 資料維護 -->
        <section id="section-faq">
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
                    <div class="flex gap-2">
                        <input type="file" id="csv-upload" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                        <button onclick="document.getElementById('csv-upload').click()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">上傳 CSV</button>
                        <button onclick="addNewFAQ()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">新增 FAQ</button>
                    </div>
                    <button onclick="saveToGitHub('faq')" class="bg-orange-500 text-white px-6 py-2 rounded font-bold hover:bg-orange-600 transition">儲存至 GitHub (FAQ.csv)</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-3 border">項次</th>
                                <th class="p-3 border">分類</th>
                                <th class="p-3 border">問題說明</th>
                                <th class="p-3 border">答案內容</th>
                                <th class="p-3 border">操作</th>
                            </tr>
                        </thead>
                        <tbody id="faq-list">
                            <!-- JS 動態插入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 分類管理 -->
        <section id="section-class" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-class-name" placeholder="輸入新分類名稱" class="border p-2 rounded flex-grow">
                    <button onclick="addClass()" class="bg-blue-600 text-white px-4 py-2 rounded">新增分類</button>
                    <button onclick="saveToGitHub('class')" class="bg-orange-500 text-white px-4 py-2 rounded">儲存至 GitHub (class.csv)</button>
                </div>
                <ul id="class-list" class="divide-y border rounded">
                    <!-- JS 動態插入 -->
                </ul>
            </div>
        </section>
    </main>

    <!-- 編輯 Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6">
            <h3 class="text-xl font-bold mb-4" id="modal-title">編輯 FAQ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">分類</label>
                    <select id="edit-category" class="w-full border p-2 rounded"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">問題說明</label>
                    <input type="text" id="edit-question" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium">答案內容 (建議 300-500 字)</label>
                    <textarea id="edit-answer" rows="8" class="w-full border p-2 rounded"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 border rounded">取消</button>
                <button onclick="saveFAQ()" class="px-4 py-2 bg-blue-600 text-white rounded">確定儲存</button>
            </div>
        </div>
    </div>

    <script>
        let faqs = [];
        let classes = ["健保補助", "儀器操作", "診所資訊", "日常護理"];
        let currentEditIndex = -1;

        // 初始化
        window.onload = () => {
            loadConfig();
            renderFAQ();
            renderClasses();
        };

        function switchTab(tab) {
            ['faq', 'class', 'config'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active-tab');
                document.getElementById(`tab-${t}`).classList.add('text-gray-500');
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active-tab');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');
        }

        // CSV 處理邏輯
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split('\n').slice(1); // 跳過標頭
                faqs = rows.filter(r => r.trim()).map((row, idx) => {
                    const cols = row.split(',');
                    return { id: idx + 1, category: cols[1], question: cols[2], answer: cols[3]?.replace(/\\n/g, '\n') };
                });
                renderFAQ();
            };
            reader.readAsText(file);
        }

        function renderFAQ() {
            const tbody = document.getElementById('faq-list');
            tbody.innerHTML = faqs.map((f, i) => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 border text-center">${i + 1}</td>
                    <td class="p-3 border">${f.category}</td>
                    <td class="p-3 border font-medium">${f.question}</td>
                    <td class="p-3 border text-gray-600 text-sm">${f.answer.substring(0, 50)}...</td>
                    <td class="p-3 border">
                        <button onclick="editFAQ(${i})" class="text-blue-600 mr-2">修改</button>
                        <button onclick="deleteFAQ(${i})" class="text-red-600">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        function addNewFAQ() {
            currentEditIndex = -1;
            document.getElementById('modal-title').innerText = "新增 FAQ";
            document.getElementById('edit-question').value = "";
            document.getElementById('edit-answer').value = "";
            updateCategorySelect();
            document.getElementById('modal').classList.remove('hidden');
        }

        function editFAQ(index) {
            currentEditIndex = index;
            const f = faqs[index];
            document.getElementById('modal-title').innerText = "修改 FAQ";
            document.getElementById('edit-question').value = f.question;
            document.getElementById('edit-answer').value = f.answer;
            updateCategorySelect(f.category);
            document.getElementById('modal').classList.remove('hidden');
        }

        function updateCategorySelect(selected = "") {
            const select = document.getElementById('edit-category');
            select.innerHTML = classes.map(c => `<option value="${c}" ${c===selected?'selected':''}>${c}</option>`).join('');
        }

        function saveFAQ() {
            const f = {
                category: document.getElementById('edit-category').value,
                question: document.getElementById('edit-question').value,
                answer: document.getElementById('edit-answer').value
            };
            if (currentEditIndex === -1) {
                faqs.push({ ...f, id: faqs.length + 1 });
            } else {
                faqs[currentEditIndex] = { ...faqs[currentEditIndex], ...f };
            }
            closeModal();
            renderFAQ();
        }

        function deleteFAQ(index) {
            if(confirm("確定刪除此題？")) {
                faqs.splice(index, 1);
                renderFAQ();
            }
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        // 分類管理邏輯
        function renderClasses() {
            const list = document.getElementById('class-list');
            list.innerHTML = classes.map((c, i) => `
                <li class="p-3 flex justify-between items-center bg-white">
                    <span>${c}</span>
                    <div>
                        <button onclick="renameClass(${i})" class="text-blue-500 mr-3 text-sm">重新命名</button>
                        <button onclick="deleteClass(${i})" class="text-red-500 text-sm">刪除</button>
                    </div>
                </li>
            `).join('');
        }

        function addClass() {
            const name = document.getElementById('new-class-name').value.trim();
            if (name) {
                classes.push(name);
                document.getElementById('new-class-name').value = "";
                renderClasses();
            }
        }

        function deleteClass(index) {
            classes.splice(index, 1);
            renderClasses();
        }

        function renameClass(index) {
            const newName = prompt("請輸入新名稱", classes[index]);
            if(newName) {
                classes[index] = newName;
                renderClasses();
            }
        }

        // GitHub 同步邏輯 (模擬)
        async function saveToGitHub(type) {
            const token = document.getElementById('gh-token').value;
            const repo = document.getElementById('gh-repo').value;
            if(!token || !repo) {
                alert("請先在『GitHub 設定』頁籤填寫 Token 與 Repo 資訊。");
                switchTab('config');
                return;
            }

            const fileName = type === 'faq' ? 'FAQ.csv' : 'class.csv';
            let content = "";
            if(type === 'faq') {
                content = "項次,分類,問題說明,答案內容\n" + faqs.map(f => `${f.id},${f.category},${f.question},${f.answer.replace(/\n/g, '\\n')}`).join('\n');
            } else {
                content = "分類名稱\n" + classes.join('\n');
            }

            // 實作提示：這裡應調用 GitHub API (PUT /repos/{owner}/{repo}/contents/{path})
            alert(`已準備好 ${fileName} 資料。\n實務上將透過 GitHub API 提交至 ${repo}。\n(目前為展示模式，請確認 console 查看 CSV 內容)`);
            console.log(content);
            
            // 儲存設定
            localStorage.setItem('gh-token', token);
            localStorage.setItem('gh-repo', repo);
        }

        function loadConfig() {
            document.getElementById('gh-token').value = localStorage.getItem('gh-token') || "";
            document.getElementById('gh-repo').value = localStorage.getItem('gh-repo') || "";
        }
    </script>
</body>
</html>