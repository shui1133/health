<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂居家呼吸照護 - 系統管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-4 lg:p-8">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">百樂居家呼吸照護所</h1>
                <p class="text-slate-500">後台管理系統 - FAQ & 分類維護</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <label class="block text-xs font-semibold text-slate-500 mb-1">GitHub Personal Access Token (臨時輸入)</label>
                <input type="password" id="tempToken" placeholder="請輸入 ghp_..." class="text-sm border rounded px-3 py-2 w-64 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
        </header>

        <nav class="flex space-x-8 mb-6 border-b border-slate-200">
            <button onclick="switchTab('faq')" id="tab-faq" class="pb-4 px-2 font-semibold tab-active">FAQ 管理</button>
            <button onclick="switchTab('class')" id="tab-class" class="pb-4 px-2 font-semibold text-slate-500 hover:text-blue-600 transition">分類管理</button>
        </nav>

        <!-- FAQ Management -->
        <div id="section-faq" class="space-y-6">
            <div class="flex flex-wrap gap-4 items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <div class="flex gap-2">
                    <button onclick="addNewFaq()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition font-medium">新增 FAQ</button>
                    <label class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm transition font-medium cursor-pointer">
                        匯入 CSV <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="handleCsvUpload(event)">
                    </label>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveToGithub('faq')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg text-sm transition font-bold shadow-md">儲存至 GitHub (FAQ.csv)</button>
                </div>
            </div>

            <div class="overflow-x-auto bg-white rounded-xl shadow-sm border border-slate-200">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="p-4 border-b font-semibold text-slate-700 w-16 text-center">項次</th>
                            <th class="p-4 border-b font-semibold text-slate-700 w-32">分類</th>
                            <th class="p-4 border-b font-semibold text-slate-700">問題說明</th>
                            <th class="p-4 border-b font-semibold text-slate-700">答案內容</th>
                            <th class="p-4 border-b font-semibold text-slate-700 w-24 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="faqTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Class Management -->
        <div id="section-class" class="hidden space-y-6">
            <div class="flex flex-wrap gap-4 items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <button onclick="addNewClass()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition font-medium">新增分類</button>
                <button onclick="saveToGithub('class')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg text-sm transition font-bold shadow-md">儲存至 GitHub (class.csv)</button>
            </div>
            
            <div class="max-w-2xl bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="p-4 border-b font-semibold text-slate-700">分類名稱</th>
                            <th class="p-4 border-b font-semibold text-slate-700 w-24 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="classTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            username: 'shui1133',
            repo: 'health',
            defaultToken: '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'
        };

        let faqData = [];
        let classData = [];

        async function init() {
            await loadFromGithub('class');
            await loadFromGithub('faq');
        }

        function switchTab(type) {
            document.getElementById('section-faq').classList.toggle('hidden', type !== 'faq');
            document.getElementById('section-class').classList.toggle('hidden', type !== 'class');
            document.getElementById('tab-faq').className = type === 'faq' ? 'pb-4 px-2 font-semibold tab-active' : 'pb-4 px-2 font-semibold text-slate-500 hover:text-blue-600';
            document.getElementById('tab-class').className = type === 'class' ? 'pb-4 px-2 font-semibold tab-active' : 'pb-4 px-2 font-semibold text-slate-500 hover:text-blue-600';
            
            if (type === 'faq') loadFromGithub('faq');
            if (type === 'class') loadFromGithub('class');
        }

        async function loadFromGithub(type) {
            const fileName = type === 'faq' ? 'FAQ.csv' : 'class.csv';
            const url = `https://raw.githubusercontent.com/${CONFIG.username}/${CONFIG.repo}/main/${fileName}?t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('檔案不存在或無法載入');
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (type === 'faq') {
                            faqData = results.data;
                            renderFaqTable();
                        } else {
                            classData = results.data;
                            renderClassTable();
                        }
                    }
                });
            } catch (err) {
                console.warn(err.message);
                if(type === 'faq' && faqData.length === 0) { faqData = [{ 項次: '1', 分類: '', 問題說明: '', 答案內容: '' }]; renderFaqTable(); }
                if(type === 'class' && classData.length === 0) { classData = [{ 分類名稱: '一般' }]; renderClassTable(); }
            }
        }

        function renderFaqTable() {
            const tbody = document.getElementById('faqTableBody');
            tbody.innerHTML = faqData.map((item, idx) => `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                    <td class="p-3 text-center text-slate-500 font-mono text-sm">${item.項次 || (idx+1)}</td>
                    <td class="p-3">
                        <select onchange="updateFaq(${idx}, '分類', this.value)" class="w-full border rounded p-1 text-sm bg-transparent border-slate-300">
                            ${classData.map(c => `<option value="${c.分類名稱}" ${item.分類 === c.分類名稱 ? 'selected' : ''}>${c.分類名稱}</option>`).join('')}
                        </select>
                    </td>
                    <td class="p-3">
                        <input type="text" value="${item.問題說明 || ''}" onchange="updateFaq(${idx}, '問題說明', this.value)" class="w-full border rounded p-1 text-sm focus:ring-1 focus:ring-blue-500">
                    </td>
                    <td class="p-3">
                        <textarea onchange="updateFaq(${idx}, '答案內容', this.value)" class="w-full border rounded p-1 text-sm h-12 focus:ring-1 focus:ring-blue-500">${item.答案內容 || ''}</textarea>
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="deleteFaq(${idx})" class="text-red-500 hover:text-red-700 text-xs font-bold uppercase tracking-wider">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderClassTable() {
            const tbody = document.getElementById('classTableBody');
            tbody.innerHTML = classData.map((item, idx) => `
                <tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="p-4">
                        <input type="text" value="${item.分類名稱 || ''}" onchange="updateClass(${idx}, this.value)" class="w-full border-b border-transparent focus:border-blue-500 bg-transparent p-1 outline-none">
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="deleteClass(${idx})" class="text-red-500 hover:text-red-700 text-xs font-bold uppercase">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateFaq(idx, key, val) { faqData[idx][key] = val; }
        function deleteFaq(idx) { faqData.splice(idx, 1); renderFaqTable(); }
        function addNewFaq() { 
            faqData.push({ 項次: faqData.length + 1, 分類: classData[0]?.分類名稱 || '', 問題說明: '', 答案內容: '' }); 
            renderFaqTable(); 
        }

        function updateClass(idx, val) { classData[idx].分類名稱 = val; }
        function deleteClass(idx) { classData.splice(idx, 1); renderClassTable(); }
        function addNewClass() { classData.push({ 分類名稱: '' }); renderClassTable(); }

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    faqData = results.data;
                    renderFaqTable();
                    alert('CSV 匯入成功');
                }
            });
        }

        async function saveToGithub(type) {
            const fileName = type === 'faq' ? 'FAQ.csv' : 'class.csv';
            const data = type === 'faq' ? faqData : classData;
            const token = document.getElementById('tempToken').value || CONFIG.defaultToken;
            
            if (!token) return alert('請輸入 GitHub Token');

            const csv = Papa.unparse(data);
            const url = `https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${fileName}`;

            try {
                // 取得檔案目前的 SHA
                const getRes = await fetch(url, { headers: { Authorization: `token ${token}` } });
                let sha = "";
                if (getRes.ok) {
                    const fileInfo = await getRes.json();
                    sha = fileInfo.sha;
                }

                // 準備提交內容
                const body = {
                    message: `更新 ${fileName} (${new Date().toLocaleString()})`,
                    content: btoa(unescape(encodeURIComponent(csv))), // 修正中文轉 Base64
                    sha: sha || undefined
                };

                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (putRes.ok) {
                    alert(`${fileName} 已成功儲存至 GitHub！`);
                } else {
                    const error = await putRes.json();
                    alert(`儲存失敗: ${error.message}`);
                }
            } catch (err) {
                alert(`錯誤: ${err.message}`);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
