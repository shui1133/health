<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂居家呼吸照護所 - 系統管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <nav class="bg-blue-700 text-white shadow-lg p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">百樂居家呼吸照護所 - 系統管理員</h1>
            <div class="space-x-4">
                <button onclick="switchPage('faq')" class="px-3 py-1 hover:bg-blue-600 rounded">FAQ 管理</button>
                <button onclick="switchPage('class')" class="px-3 py-1 hover:bg-blue-600 rounded">分類管理</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        <!-- FAQ 頁面 -->
        <section id="page-faq" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-800">FAQ 資料管理</h2>
                <div class="space-x-2">
                    <input type="file" id="csvImport" accept=".csv" class="hidden" onchange="importCSV(event)">
                    <button onclick="document.getElementById('csvImport').click()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">匯入 CSV</button>
                    <button onclick="openFAQModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">手動新增</button>
                    <button onclick="saveToGitHub('FAQ.csv', faqData)" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 font-bold">儲存至 GitHub</button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-3">項次</th>
                            <th class="p-3">分類</th>
                            <th class="p-3">問題說明</th>
                            <th class="p-3">答案內容</th>
                            <th class="p-3">操作</th>
                        </tr>
                    </thead>
                    <tbody id="faqTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- 分類頁面 -->
        <section id="page-class" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-800">分類項目管理</h2>
                <div class="space-x-2">
                    <button onclick="addClassItem()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">新增分類</button>
                    <button onclick="saveToGitHub('class.csv', classData)" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 font-bold">同步分類至 GitHub</button>
                </div>
            </div>
            <div class="max-w-md bg-white rounded-lg shadow p-4">
                <ul id="classList" class="divide-y"></ul>
            </div>
        </section>
    </main>

    <!-- FAQ Modal -->
    <div id="faqModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-full max-w-2xl">
            <h3 id="modalTitle" class="text-xl font-bold mb-4">新增 FAQ</h3>
            <div class="space-y-4">
                <input type="hidden" id="editIndex">
                <div>
                    <label class="block text-sm font-medium">分類</label>
                    <select id="modalCategory" class="w-full border p-2 rounded"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium">問題說明</label>
                    <input type="text" id="modalQuestion" class="w-full border p-2 rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium">答案內容</label>
                    <textarea id="modalAnswer" rows="6" class="w-full border p-2 rounded"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button onclick="closeFAQModal()" class="px-4 py-2 border rounded">取消</button>
                <button onclick="saveFAQItem()" class="px-4 py-2 bg-blue-600 text-white rounded">確認</button>
            </div>
        </div>
    </div>

    <script>
        // 設定與資料
        const CONFIG = {
            owner: 'shui1133',
            repo: 'health',
            token: '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' // 警告：實際環境建議透過後端轉發，此處依需求放入前端
        };

        let faqData = [];
        let classData = [];

        async function init() {
            await loadInitialData();
            renderFAQ();
            renderClass();
        }

        async function loadInitialData() {
            // 模擬從 GitHub 載入，初次若無檔案則為空
            try {
                const resFaq = await fetch(`https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/main/FAQ.csv`);
                if(resFaq.ok) {
                    const text = await resFaq.text();
                    faqData = Papa.parse(text, {header: true}).data.filter(i => i.項次);
                }
                const resClass = await fetch(`https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/main/class.csv`);
                if(resClass.ok) {
                    const text = await resClass.text();
                    classData = Papa.parse(text, {header: false}).data.map(i => i[0]).filter(i => i);
                }
            } catch (e) {
                console.log("初始化載入失敗或檔案不存在");
            }
        }

        // 頁面切換
        function switchPage(page) {
            document.getElementById('page-faq').classList.toggle('hidden', page !== 'faq');
            document.getElementById('page-class').classList.toggle('hidden', page !== 'class');
            if(page === 'faq') loadInitialData().then(renderFAQ);
            if(page === 'class') loadInitialData().then(renderClass);
        }

        // FAQ 功能
        function renderFAQ() {
            const tbody = document.getElementById('faqTableBody');
            tbody.innerHTML = faqData.map((item, index) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${item.項次}</td>
                    <td class="p-3">${item.分類}</td>
                    <td class="p-3 font-medium">${item.問題說明}</td>
                    <td class="p-3 text-gray-600 text-sm truncate max-w-xs">${item.答案內容}</td>
                    <td class="p-3 space-x-2">
                        <button onclick="openFAQModal(${index})" class="text-blue-600">修改</button>
                        <button onclick="deleteFAQ(${index})" class="text-red-600">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        function openFAQModal(index = -1) {
            const modal = document.getElementById('faqModal');
            const catSelect = document.getElementById('modalCategory');
            catSelect.innerHTML = classData.map(c => `<option value="${c}">${c}</option>`).join('');
            
            if(index > -1) {
                const item = faqData[index];
                document.getElementById('editIndex').value = index;
                document.getElementById('modalQuestion').value = item.問題說明;
                document.getElementById('modalAnswer').value = item.答案內容;
                catSelect.value = item.分類;
                document.getElementById('modalTitle').innerText = "修改 FAQ";
            } else {
                document.getElementById('editIndex').value = "";
                document.getElementById('modalQuestion').value = "";
                document.getElementById('modalAnswer').value = "";
                document.getElementById('modalTitle').innerText = "新增 FAQ";
            }
            modal.classList.remove('hidden');
        }

        function closeFAQModal() {
            document.getElementById('faqModal').classList.add('hidden');
        }

        function saveFAQItem() {
            const idx = document.getElementById('editIndex').value;
            const newItem = {
                項次: idx !== "" ? faqData[idx].項次 : (faqData.length + 1),
                分類: document.getElementById('modalCategory').value,
                問題說明: document.getElementById('modalQuestion').value,
                答案內容: document.getElementById('modalAnswer').value
            };

            if(idx !== "") faqData[idx] = newItem;
            else faqData.push(newItem);

            renderFAQ();
            closeFAQModal();
        }

        function deleteFAQ(index) {
            if(confirm("確定刪除？")) {
                faqData.splice(index, 1);
                renderFAQ();
            }
        }

        function importCSV(event) {
            const file = event.target.files[0];
            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    faqData = results.data.filter(i => i.問題說明);
                    renderFAQ();
                    alert("匯入成功！記得按下儲存同步到 GitHub");
                }
            });
        }

        // 分類功能
        function renderClass() {
            const list = document.getElementById('classList');
            list.innerHTML = classData.map((item, index) => `
                <li class="py-2 flex justify-between items-center">
                    <span>${item}</span>
                    <div class="space-x-2">
                        <button onclick="editClass(${index})" class="text-blue-600 text-sm">修改</button>
                        <button onclick="deleteClass(${index})" class="text-red-600 text-sm">刪除</button>
                    </div>
                </li>
            `).join('');
        }

        function addClassItem() {
            const name = prompt("請輸入新分類名稱：");
            if(name) {
                classData.push(name);
                renderClass();
            }
        }

        function deleteClass(index) {
            if(confirm("刪除分類可能導致部分 FAQ 無法歸類，確定？")) {
                classData.splice(index, 1);
                renderClass();
            }
        }

        function editClass(index) {
            const name = prompt("修改分類名稱：", classData[index]);
            if(name) {
                classData[index] = name;
                renderClass();
            }
        }

        // GitHub 同步功能
        async function saveToGitHub(filename, data) {
            const csv = Papa.unparse(data);
            const path = filename;
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}`;
            
            try {
                // 獲取目前的 SHA (更新必須要有 SHA)
                let sha = "";
                const getRes = await fetch(url, {
                    headers: { "Authorization": `token ${CONFIG.token}` }
                });
                if(getRes.ok) {
                    const fileInfo = await getRes.json();
                    sha = fileInfo.sha;
                }

                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        "Authorization": `token ${CONFIG.token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: `Update ${filename} via Admin UI`,
                        content: btoa(unescape(encodeURIComponent(csv))),
                        sha: sha || undefined
                    })
                });

                if(putRes.ok) alert(`${filename} 已成功儲存至 GitHub!`);
                else alert("儲存失敗，請檢查權限或網路");
            } catch (e) {
                console.error(e);
                alert("發生錯誤：" + e.message);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
