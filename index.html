<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾æ¨‚å±…å®¶å‘¼å¸ç…§è­·æ‰€ - èªéŸ³æ™ºæ…§åŠ©æ‰‹</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIueZvuWoguWxiuWutuaRreWQveeFp+ittOaJgCIsCiAgInNob3J0X25hbWUiIjogIueZvuWoguWRvOmAmiIsCiAgInN0YXJ0X3VybCI6ICIuLmluZGV4Lmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMWQ0ZWRmIgp9">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-bubble { max-width: 85%; }
        .recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
        <h1 class="text-lg font-bold">ç™¾æ¨‚å±…å®¶å‘¼å¸åŠ©æ‰‹</h1>
        <div id="online-status" class="text-xs bg-green-500 px-2 py-1 rounded">åœ¨ç·š</div>
    </header>

    <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
    <main id="chat-container" class="flex-grow overflow-y-auto p-4 space-y-4">
        <div class="flex justify-start">
            <div class="bg-white p-3 rounded-lg shadow-sm chat-bubble">
                æ‚¨å¥½ï¼æˆ‘æ˜¯ç™¾æ¨‚å°åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥è¼¸å…¥æ–‡å­—æˆ–é»æ“Šä¸‹æ–¹éº¥å…‹é¢¨å°æˆ‘èªªè©±ï¼Œè©¢å•å¥ä¿è£œåŠ©æˆ–å„€å™¨ä½¿ç”¨å•é¡Œã€‚
            </div>
        </div>
    </main>

    <!-- æ§åˆ¶é¢æ¿ -->
    <footer class="bg-white p-4 border-t">
        <div id="summary-notice" class="hidden text-xs text-orange-600 mb-2">â€» ç­”æ¡ˆè¼ƒé•·ï¼Œå·²è‡ªå‹•ç‚ºæ‚¨æ’­æ”¾æ‘˜è¦ã€‚</div>
        
        <div class="flex items-center space-x-2">
            <button id="mic-btn" class="bg-blue-100 p-3 rounded-full text-blue-600 hover:bg-blue-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
            <input type="text" id="user-input" placeholder="è«‹è¼¸å…¥å•é¡Œ..." class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="send-btn" class="bg-blue-600 text-white p-2 rounded-full px-4">å‚³é€</button>
        </div>

        <div class="flex justify-center mt-3 space-x-4">
            <button id="speak-last" class="text-sm bg-gray-100 px-3 py-1 rounded border hover:bg-gray-200">ğŸ”Š é‡æ’­èªéŸ³</button>
            <button id="stop-speak" class="text-sm bg-red-50 px-3 py-1 rounded border border-red-200 text-red-600 hover:bg-red-100">â¹ åœæ­¢æ’­æ”¾</button>
        </div>
    </footer>

    <script>
        // è¨­å®šèˆ‡è³‡æ–™
        const CLAUDE_API_KEY = ""; // é ç•™ä½ç½®
        const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/shui1133/health/main/";
        const SYNONYMS = {
            "æ°§æ°£æ©Ÿ": "è£½æ°§æ©Ÿ",
            "å‘¼å¸å™¨": "å–®é™½å£“å‘¼å¸è¼”åŠ©å™¨",
            "è£œåŠ©": "è²»ç”¨èªªæ˜"
        };

        let faqData = [];
        let lastAnswer = "";

        // èªéŸ³çµ„ä»¶
        const recognition = window.SpeechRecognition || window.webkitSpeechRecognition ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
        if(recognition) {
            recognition.lang = 'zh-TW';
            recognition.continuous = false;
        }

        const synth = window.speechSynthesis;

        window.onload = async () => {
            await fetchFAQ();
            setupEventListeners();
            checkOffline();
        };

        async function fetchFAQ() {
            try {
                // å˜—è©¦å¾ GitHub æŠ“å–æœ€æ–° CSV
                const res = await fetch(GITHUB_RAW_BASE + "FAQ.csv");
                const text = await res.text();
                parseCSV(text);
            } catch (e) {
                console.error("ç„¡æ³•è¼‰å…¥ç·šä¸Š FAQï¼Œæª¢æŸ¥é›¢ç·šå¿«å–");
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            faqData = lines.slice(1).filter(l => l.trim() !== '').map(line => {
                const parts = line.split(',');
                return {
                    question: parts[2],
                    answer: parts.slice(3).join(',').replace(/^"|"$/g, '')
                };
            });
        }

        function setupEventListeners() {
            document.getElementById('send-btn').onclick = () => handleSearch(document.getElementById('user-input').value);
            document.getElementById('user-input').onkeypress = (e) => { if(e.key === 'Enter') handleSearch(e.target.value); };
            
            if(recognition) {
                document.getElementById('mic-btn').onclick = () => {
                    recognition.start();
                    document.getElementById('mic-btn').classList.add('recording');
                };
                recognition.onresult = (e) => {
                    const transcript = e.results[0][0].transcript;
                    document.getElementById('user-input').value = transcript;
                    handleSearch(transcript);
                };
                recognition.onend = () => document.getElementById('mic-btn').classList.remove('recording');
            }

            document.getElementById('speak-last').onclick = () => speakText(lastAnswer);
            document.getElementById('stop-speak').onclick = () => synth.cancel();
        }

        function handleSearch(query) {
            if(!query.trim()) return;
            appendMsg(query, 'user');
            document.getElementById('user-input').value = '';

            // åŒç¾©è©è½‰æ›
            let processedQuery = query;
            for(let key in SYNONYMS) {
                if(query.includes(key)) processedQuery = query.replace(key, SYNONYMS[key]);
            }

            // å„ªå…ˆæ‰¾ FAQ
            const match = faqData.find(item => item.question.includes(processedQuery) || processedQuery.includes(item.question));
            
            if(match) {
                showResponse(match.answer);
            } else {
                callClaudeAPI(query);
            }
        }

        async function callClaudeAPI(query) {
            appendMsg("æ­£åœ¨æœå°‹é€²ä¸€æ­¥è³‡è¨Š...", 'bot-loading');
            
            // æ­¤è™•ç‚ºå°‡ä¾†ä¸²æ¥ Claude API çš„é‚è¼¯
            // ç”±æ–¼ç›®å‰ç„¡ Keyï¼Œæ¨¡æ“¬ä¸€å€‹å›è¦†
            setTimeout(() => {
                const botLoading = document.querySelector('.bot-loading');
                if(botLoading) botLoading.remove();
                
                const fallbackMsg = "åœ¨ç›®å‰ FAQ ä¸­æ‰¾ä¸åˆ°å®Œå…¨ç›¸ç¬¦çš„ç­”æ¡ˆã€‚å»ºè­°æ‚¨è¯ç¹«è¨ºæ‰€å€‹ç®¡å¸«é€²ä¸€æ­¥è«®è©¢ï¼Œæˆ–æ’¥æ‰“ (02)XXXX-XXXXã€‚";
                showResponse(fallbackMsg);
            }, 1000);
        }

        function showResponse(text) {
            lastAnswer = text;
            appendMsg(text, 'bot');
            
            // èªéŸ³æ’­æ”¾ç­–ç•¥ï¼šè¶…é 500 å­—å‰‡æ‘˜è¦ (é€™è£¡ç°¡å–®å–å‰ 50 å­—ä½œç‚ºæ‘˜è¦æ¼”ç¤º)
            let speakContent = text;
            if(text.length > 500) {
                speakContent = "ç­”æ¡ˆå…§å®¹è¼ƒé•·ï¼Œç‚ºæ‚¨ç¯€éŒ„é‡é»ï¼š" + text.substring(0, 100) + "...è©³ç´°å…§å®¹è«‹è¦‹è¢å¹•é¡¯ç¤ºã€‚";
                document.getElementById('summary-notice').classList.remove('hidden');
            } else {
                document.getElementById('summary-notice').classList.add('hidden');
            }
            speakText(speakContent);
        }

        function appendMsg(text, sender) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} ${sender === 'bot-loading' ? 'bot-loading' : ''}`;
            div.innerHTML = `
                <div class="${sender === 'user' ? 'bg-blue-500 text-white' : 'bg-white text-gray-800'} p-3 rounded-lg shadow-sm chat-bubble">
                    ${text}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function speakText(text) {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.0;
            synth.speak(utterance);
        }

        function checkOffline() {
            window.addEventListener('online', () => updateStatus(true));
            window.addEventListener('offline', () => updateStatus(false));
        }

        function updateStatus(isOnline) {
            const status = document.getElementById('online-status');
            status.innerText = isOnline ? 'åœ¨ç·š' : 'é›¢ç·šæ¨¡å¼';
            status.className = `text-xs px-2 py-1 rounded ${isOnline ? 'bg-green-500' : 'bg-orange-500'}`;
        }
    </script>

    <!-- ç°¡æ˜“ Service Worker è¨»å†Š -->
    <script>
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'baile-v1';
                self.addEventListener('install', e => {
                    e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./index.html'])));
                });
                self.addEventListener('fetch', e => {
                    e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
                });
            `;
            const blob = new Blob([swCode], {type: 'text/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }
    </script>
</body>
</html>