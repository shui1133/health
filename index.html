<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¼å¸æ²»ç™‚è«®è©¢åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIuWRvOetalrmsrvnmYLosqzoq68iLAogICJzaG9ydF9uYW1lIjogIuWRvOetalpBSSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzI1NjNlYiIKfQ==">
    <style>
        .chat-container { height: calc(100vh - 180px); }
        .bubble { max-width: 85%; border-radius: 1.25rem; }
        .pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ğŸ«</span>
            <h1 class="font-bold">å‘¼å¸æ²»ç™‚è«®è©¢åŠ©æ‰‹</h1>
        </div>
        <div id="offlineBadge" class="hidden bg-orange-500 text-xs px-2 py-1 rounded">é›¢ç·šæ¨¡å¼</div>
    </header>

    <!-- Chat Area -->
    <main id="chatWindow" class="chat-container overflow-y-auto p-4 space-y-4 flex-1">
        <div class="flex justify-start">
            <div class="bubble bg-white p-3 shadow-sm text-gray-800">
                æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å‘¼å¸æ²»ç™‚åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥è¼¸å…¥å•é¡Œï¼Œæˆ–æ˜¯é»æ“Šä¸‹æ–¹çš„éº¥å…‹é¢¨ç”¨èªªçš„ã€‚
            </div>
        </div>
    </main>

    <!-- Controls -->
    <footer class="bg-white p-4 border-t shadow-inner">
        <div id="ttsControls" class="hidden mb-2 flex items-center justify-between bg-blue-50 p-2 rounded">
            <span class="text-xs text-blue-600">æ­£åœ¨èªéŸ³æ’­æ”¾ä¸­...</span>
            <button onclick="stopTTS()" class="text-red-500 text-sm font-bold">åœæ­¢æ’­æ”¾</button>
        </div>
        
        <div class="flex gap-2">
            <button id="voiceBtn" onclick="toggleSTT()" class="bg-gray-100 p-3 rounded-full hover:bg-gray-200 transition">
                ğŸ¤
            </button>
            <input type="text" id="userInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..." class="flex-1 border rounded-full px-4 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <button onclick="handleSend()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold">å‚³é€</button>
        </div>
    </footer>

    <script>
        // è¨­å®šèˆ‡åŒç¾©è©å­—å…¸
        const API_KEY = ""; // é ç•™ä¸²æ¥ API å¯†é‘°
        const SYNONYMS = {
            "æ°§æ°£æ©Ÿ": "è£½æ°§æ©Ÿ",
            "è£½æ°§æ©Ÿ": "æ°§æ°£æ©Ÿ",
            "å‘¼å¸å™¨": "å–®ç›¸é™½å£“å‘¼å¸å™¨",
            "è£œåŠ©": "æ´¥è²¼",
            "å™´éœ§": "éœ§åŒ–å™¨"
        };

        let localFAQ = [];
        let isRecording = false;
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;

        // åˆå§‹åŒ–ï¼šè®€å– GitHub è³‡æ–™ (æˆ–æœ¬åœ°å¿«å–)
        window.onload = async () => {
            await fetchFAQ();
            registerPWA();
            checkOnlineStatus();
        };

        async function fetchFAQ() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/shui1133/health/main/FAQ.csv');
                if (response.ok) {
                    const text = await response.text();
                    parseCSV(text);
                    localStorage.setItem('cachedFAQ', text);
                } else {
                    const cached = localStorage.getItem('cachedFAQ');
                    if (cached) parseCSV(cached);
                }
            } catch (e) {
                const cached = localStorage.getItem('cachedFAQ');
                if (cached) parseCSV(cached);
            }
        }

        function parseCSV(text) {
            const rows = text.split('\n').slice(1);
            localFAQ = rows.map(row => {
                const cols = row.split(',');
                if (cols.length >= 4) {
                    return { 
                        category: cols[1], 
                        question: cols[2], 
                        answer: cols[3].replace(/"/g, '').replace(/\\n/g, '\n') 
                    };
                }
                return null;
            }).filter(i => i);
        }

        // æœå°‹é‚è¼¯
        function findAnswer(query) {
            // åŒç¾©è©æ›¿æ›
            let processedQuery = query;
            for (const [key, val] of Object.entries(SYNONYMS)) {
                if (query.includes(key)) processedQuery += " " + val;
            }

            // ç°¡å–®æ¨¡ç³Šæœå°‹
            return localFAQ.find(item => 
                processedQuery.split(' ').some(q => item.question.includes(q))
            );
        }

        async function handleSend() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';

            const match = findAnswer(text);
            if (match) {
                respond(match.answer);
            } else {
                // æ‰¾ä¸åˆ°å‰‡è§¸ç™¼ API (æ­¤è™•æ¨¡æ“¬ Gemini/Claude)
                addMessage("æ­£åœ¨å°‹æ‰¾æ›´è©³ç›¡çš„è§£ç­”...", 'ai', true);
                const aiResult = await fetchAIAnswer(text);
                removeLoading();
                respond(aiResult);
            }
        }

        async function fetchAIAnswer(prompt) {
            // é€™è£¡å¯¦ä½œ API ä¸²æ¥é‚è¼¯
            // å¦‚æœ API_KEY ç‚ºç©ºï¼Œå‰‡è¿”å›é è¨­æç¤º
            if (!API_KEY) return "æŠ±æ­‰ï¼Œç›®å‰æ‰¾ä¸åˆ°ç›¸é—œ FAQï¼Œè«‹è¯çµ¡æ«ƒæª¯äººå“¡ (02)XXXX-XXXXã€‚";
            
            // é€™è£¡å¯ä»¥ä½¿ç”¨ Gemini 2.5 Flash é€²è¡ŒæŸ¥è©¢
            return "é€™æ˜¯ç”± AI ç”Ÿæˆçš„å»ºè­°è§£ç­”ï¼šå‘¼å¸æ²»ç™‚ç›¸é—œè£œåŠ©é€šå¸¸éœ€è¦æª¢é™„è¨ºæ–·è­‰æ˜æ›¸èˆ‡èº«éšœæ‰‹å†Š...";
        }

        function respond(fullText) {
            addMessage(fullText, 'ai');
            
            // èªéŸ³æ’­æ”¾ç­–ç•¥ï¼šé•·ç¯‡å‰‡æ‘˜è¦
            let voiceText = fullText;
            if (fullText.length > 500) {
                voiceText = "å…§å®¹è¼ƒé•·ï¼Œç‚ºæ‚¨æ‘˜è¦ï¼š" + fullText.substring(0, 100) + "...è©³ç´°å…§å®¹è«‹è¦‹æ–‡å­—èªªæ˜ã€‚";
            }
            
            // è‡ªå‹•é¡¯ç¤ºèªéŸ³æŒ‰éˆ•
            speak(voiceText);
        }

        // UI å…ƒä»¶
        function addMessage(text, role, isLoading = false) {
            const win = document.getElementById('chatWindow');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="bubble p-3 shadow-sm ${role === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800'} ${isLoading ? 'pulse' : ''}">
                    ${text.replace(/\n/g, '<br>')}
                    ${role === 'ai' && !isLoading ? '<button onclick="repeatVoice(this)" class="ml-2 text-xs border border-gray-300 rounded px-1">ğŸ”Š æ’­æ”¾</button>' : ''}
                </div>
            `;
            div.id = isLoading ? 'loadingMsg' : '';
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        function removeLoading() {
            const el = document.getElementById('loadingMsg');
            if (el) el.remove();
        }

        // èªéŸ³åŠŸèƒ½ (TTS)
        function speak(text) {
            stopTTS();
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'zh-TW';
            currentUtterance.onstart = () => document.getElementById('ttsControls').classList.remove('hidden');
            currentUtterance.onend = () => document.getElementById('ttsControls').classList.add('hidden');
            synthesis.speak(currentUtterance);
        }

        function stopTTS() {
            synthesis.cancel();
            document.getElementById('ttsControls').classList.add('hidden');
        }

        function repeatVoice(btn) {
            const text = btn.parentElement.innerText.replace('ğŸ”Š æ’­æ”¾', '');
            speak(text);
        }

        // èªéŸ³è¾¨è­˜ (STT)
        function toggleSTT() {
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Recognition) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜");
                return;
            }

            const rec = new Recognition();
            rec.lang = 'zh-TW';
            
            if (!isRecording) {
                rec.start();
                document.getElementById('voiceBtn').classList.add('bg-red-100');
                isRecording = true;
            }

            rec.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                handleSend();
            };

            rec.onend = () => {
                document.getElementById('voiceBtn').classList.remove('bg-red-100');
                isRecording = false;
            };
        }

        // PWA èˆ‡ é›¢ç·šæ”¯æ´
        function registerPWA() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            fetch(event.request).catch(() => caches.match(event.request))
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob));
            }
        }

        function checkOnlineStatus() {
            const badge = document.getElementById('offlineBadge');
            const updateStatus = () => {
                badge.classList.toggle('hidden', navigator.onLine);
            };
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            updateStatus();
        }
    </script>
</body>
</html>