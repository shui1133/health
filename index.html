<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂居家呼吸照護系統</title>
    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22百樂呼吸%22,%22short_name%22:%22百樂%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22theme_color%22:%22#2563eb%22}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .chat-bubble { max-width: 85%; }
        /* 自定義捲軸 */
        #chatWindow::-webkit-scrollbar { width: 6px; }
        #chatWindow::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-white p-1 rounded-full">
                    <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                </div>
                <h1 class="text-xl font-bold">百樂居家呼吸照護服務</h1>
            </div>
            <div class="flex gap-2">
                <!-- 停止語音按鈕 -->
                <button id="stopVoiceBtn" onclick="stopSpeaking()" class="bg-red-500 hover:bg-red-600 px-4 py-1.5 rounded-full text-sm font-bold shadow-md transition-all hidden flex items-center gap-1">
                    <span>■ 停止播放</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <main id="chatWindow" class="flex-grow max-w-4xl w-full mx-auto p-4 space-y-6 overflow-y-auto pb-36">
        <div class="flex justify-start">
            <div class="bg-white border border-slate-200 p-4 rounded-2xl rounded-tl-none shadow-sm chat-bubble">
                <p class="font-semibold text-blue-600 mb-1">系統管理員您好：</p>
                歡迎使用百樂居家呼吸照護助理。您可以直接提問，或使用下方的語音按鈕進行對話。
            </div>
        </div>
    </main>

    <!-- Input & Voice Controls -->
    <footer class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-slate-200 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="max-w-4xl mx-auto flex flex-col gap-3">
            <div class="flex items-center gap-3">
                <!-- 語音輸入按鈕 (錄音) -->
                <button id="micBtn" onclick="toggleVoiceInput()" title="語音提問" class="w-12 h-12 bg-slate-100 hover:bg-slate-200 rounded-full flex items-center justify-center transition shrink-0 shadow-sm border border-slate-200">
                    <svg id="micIcon" class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </button>
                
                <!-- 文字輸入框 -->
                <input type="text" id="userInput" placeholder="輸入問題或語音提問..." class="flex-grow bg-slate-100 border-none rounded-2xl px-5 py-3.5 focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-inner" onkeypress="if(event.key==='Enter') sendMessage()">
                
                <!-- 語音朗讀最後答案按鈕 -->
                <button id="readLastBtn" onclick="speakLastAnswer()" title="語音回答最後一個問題" class="w-12 h-12 bg-orange-100 hover:bg-orange-200 text-orange-600 rounded-full flex items-center justify-center transition shrink-0 shadow-sm border border-orange-200">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.982 5.982 0 0115 10a5.982 5.982 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.982 3.982 0 0013 10a3.982 3.982 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg>
                </button>

                <!-- 傳送按鈕 -->
                <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-3.5 rounded-2xl hover:bg-blue-700 font-bold transition-all shadow-md active:scale-95">傳送</button>
            </div>
            <div id="statusInfo" class="flex justify-between px-2 text-[10px] text-slate-400 font-mono tracking-wider uppercase">
                <span>PWA 離線支援中</span>
                <span id="loadStatus">FAQ 資料載入中...</span>
            </div>
        </div>
    </footer>

    <!-- Claude API 金鑰隱藏欄位 (預留) -->
    <input type="hidden" id="claudeKey" value="">

    <script>
        const CONFIG = {
            username: 'shui1133',
            repo: 'health',
            synonyms: {
                "氧氣機": ["製氧機", "氧氣產生器", "製氧器", "O2機"],
                "呼吸機": ["呼吸輔助器", "CPAP", "BiPAP", "單向正壓", "雙向正壓"],
                "補助": ["申請金", "津貼", "費用補助", "健保給付"],
                "抽痰": ["吸痰", "清理呼吸道", "化痰機"]
            }
        };

        let faqData = [];
        let synth = window.speechSynthesis;
        let recognition = null;
        let lastAnswerText = "";

        // 初始化
        async function init() {
            loadFaq();
            initSpeechRecognition();
            registerServiceWorker();
        }

        async function loadFaq() {
            const statusEl = document.getElementById('loadStatus');
            const url = `https://raw.githubusercontent.com/${CONFIG.username}/${CONFIG.repo}/main/FAQ.csv?t=${Date.now()}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("GitHub 檔案讀取失敗");
                const csv = await res.text();
                Papa.parse(csv, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => { 
                        faqData = results.data; 
                        statusEl.innerText = "資料同步完成";
                    }
                });
            } catch (e) {
                console.error(e);
                statusEl.innerText = "無法載入雲端資料";
            }
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    document.getElementById('micBtn').classList.add('recording-pulse', 'bg-red-50', 'border-red-200');
                    document.getElementById('micIcon').classList.add('text-red-600');
                    document.getElementById('userInput').placeholder = "正在聽您說話...";
                };

                recognition.onend = () => {
                    document.getElementById('micBtn').classList.remove('recording-pulse', 'bg-red-50', 'border-red-200');
                    document.getElementById('micIcon').classList.remove('text-red-600');
                    document.getElementById('userInput').placeholder = "輸入問題或語音提問...";
                };

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('userInput').value = text;
                    sendMessage();
                };
            }
        }

        function toggleVoiceInput() {
            if (!recognition) return alert("您的瀏覽器不支援語音辨識。請使用 Chrome 或 Edge。");
            try { recognition.start(); } catch(e) { recognition.stop(); }
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const query = input.value.trim();
            if (!query) return;

            addChatBubble('user', query);
            input.value = '';

            // 1. 優先查詢本地 FAQ
            const localResult = searchFaq(query);
            
            if (localResult) {
                handleResponse(localResult);
            } else {
                // 2. 本地查無資料，預留 Claude API 串接介面
                handleFallbackResponse(query);
            }
        }

        function searchFaq(query) {
            let processedQuery = query.toLowerCase();
            
            // 同義詞預處理
            for (const [key, aliases] of Object.entries(CONFIG.synonyms)) {
                aliases.forEach(alias => {
                    if (processedQuery.includes(alias)) processedQuery = processedQuery.replace(alias, key);
                });
            }

            // 搜尋 FAQ.csv 內容
            const result = faqData.find(item => 
                (item.問題說明 && item.問題說明.toLowerCase().includes(processedQuery)) || 
                (item.答案內容 && item.答案內容.toLowerCase().includes(processedQuery))
            );

            return result ? result.答案內容 : null;
        }

        function handleResponse(text) {
            lastAnswerText = text;
            addChatBubble('bot', text);
            // 自動播放回答 (符合需求：回答問題後自動語音)
            speakText(text);
        }

        async function handleFallbackResponse(query) {
            const fallbackMsg = "在 FAQ 資料庫中暫無直接匹配的結果。";
            addChatBubble('bot', fallbackMsg + " 正在嘗試進行網路補充查詢 (Claude API 預留位置)...");
            
            // 此處將來串接 Claude API 邏輯
            // const apiResult = await callClaudeAPI(query);
            // handleResponse(apiResult);
            
            lastAnswerText = fallbackMsg;
            speakText(fallbackMsg);
        }

        function addChatBubble(role, text) {
            const win = document.getElementById('chatWindow');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const isBot = role === 'bot';
            div.innerHTML = `
                <div class="p-4 rounded-2xl shadow-sm chat-bubble ${isBot ? 'bg-white border border-slate-200 rounded-tl-none text-slate-700' : 'bg-blue-600 text-white rounded-tr-none'}">
                    <div class="leading-relaxed whitespace-pre-wrap">${text}</div>
                    ${isBot ? `
                        <div class="flex gap-4 mt-3 pt-3 border-t border-slate-100">
                            <button onclick="speakText(lastAnswerText)" class="text-xs text-blue-500 hover:text-blue-700 font-medium flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg> 重新播放
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        // 核心語音播放邏輯
        function speakText(text) {
            stopSpeaking();
            
            let utteranceText = text;
            
            // 語音播放策略：長篇回答（例如超過 500 字）自動產生摘要版本
            if (text.length > 500) {
                const summary = text.split(/[。！？\n]/).filter(s => s.trim().length > 0);
                utteranceText = "這份回答內容較長，為您語音摘要前段內容：" + 
                                summary.slice(0, 3).join('。') + 
                                "。詳細完整內容請參閱畫面說明。";
            }

            const utterance = new SpeechSynthesisUtterance(utteranceText);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            
            utterance.onstart = () => {
                document.getElementById('stopVoiceBtn').classList.remove('hidden');
            };
            
            utterance.onend = () => {
                document.getElementById('stopVoiceBtn').classList.add('hidden');
            };

            synth.speak(utterance);
        }

        // 語音按鈕：回答最後一個問題
        function speakLastAnswer() {
            if (!lastAnswerText) {
                speakText("目前沒有可以播放的回答內容。");
                return;
            }
            speakText(lastAnswerText);
        }

        // 停止按鈕
        function stopSpeaking() {
            if (synth.speaking) {
                synth.cancel();
            }
            document.getElementById('stopVoiceBtn').classList.add('hidden');
        }

        // PWA & Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'baile-v2';
                    const ASSETS = ['./', './index.html'];
                    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS))));
                    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
                `;
                const blob = new Blob([swContent], {type: 'application/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(err => console.log('SW error', err));
            }
        }

        window.onload = init;
    </script>
</body>
</html>
