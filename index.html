<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂居家呼吸照護所 - 智能助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22百樂呼吸助手%22,%22short_name%22:%22呼吸助手%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%231d4ed8%22}">
    <style>
        .chat-bubble { max-width: 85%; border-radius: 18px; padding: 12px 16px; margin-bottom: 8px; }
        .user-bubble { background-color: #1d4ed8; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .ai-bubble { background-color: #f3f4f6; color: #1f2937; margin-right: auto; border-bottom-left-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">
    <header class="bg-blue-700 text-white p-4 shadow-md flex justify-between items-center">
        <div>
            <h1 class="font-bold text-lg">百樂居家呼吸照護所</h1>
            <p class="text-xs opacity-80">智能諮詢系統 (含離線/語音支援)</p>
        </div>
        <button id="stopVoiceBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm hidden">停止播放</button>
    </header>

    <main id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="ai-bubble chat-bubble shadow-sm">
            您好！我是百樂居家呼吸照護所的小助手。您可以詢問關於健保補助、氧氣機使用、或呼吸照護的相關問題。
        </div>
    </main>

    <footer class="p-4 bg-white border-t">
        <div class="flex items-center space-x-2 max-w-4xl mx-auto">
            <button id="micBtn" class="p-3 bg-gray-100 rounded-full hover:bg-gray-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
            <input type="text" id="userInput" placeholder="請輸入或說話提問..." class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="handleSend()" class="bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700">發送</button>
        </div>
        <div id="voiceStatus" class="text-center text-xs text-gray-400 mt-2 h-4"></div>
    </footer>

    <script>
        const owner = 'shui1133';
        const repo = 'health';
        let faqLibrary = [];
        const synonyms = { "氧氣機": "製氧機", "製氧機": "氧氣機", "呼吸機": "呼吸器", "補助": "津貼" };
        
        // 語音合成與辨識
        const synth = window.speechSynthesis;
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = Recognition ? new Recognition() : null;
        if(recognition) {
            recognition.lang = 'zh-TW';
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('userInput').value = text;
                handleSend();
            };
            recognition.onstart = () => document.getElementById('voiceStatus').innerText = "正在聆聽中...";
            recognition.onend = () => document.getElementById('voiceStatus').innerText = "";
        }

        async function init() {
            try {
                const res = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/FAQ.csv`);
                const text = await res.text();
                faqLibrary = Papa.parse(text, {header: true}).data;
            } catch (e) {
                console.error("無法載入 FAQ 庫，嘗試讀取離線快取");
            }
        }

        function handleSend() {
            const input = document.getElementById('userInput').value.trim();
            if(!input) return;
            addMessage(input, 'user');
            document.getElementById('userInput').value = '';
            processQuery(input);
        }

        function addMessage(text, role) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `${role}-bubble chat-bubble shadow-sm`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function processQuery(query) {
            // 處理同義詞
            let processedQuery = query;
            for(let key in synonyms) {
                if(query.includes(key)) processedQuery += " " + synonyms[key];
            }

            // 本地 FAQ 搜尋 (簡單關鍵字命中)
            const result = faqLibrary.find(item => 
                (item.問題說明 && item.問題說明.includes(query)) || 
                (item.答案內容 && item.答案內容.includes(query))
            );

            if(result) {
                respond(result.答案內容);
            } else {
                // 觸發 AI (預留 API 呼叫點)
                addMessage("正在為您從網路獲取進一步資訊...", 'ai');
                // 這裡將來串接 Claude API: callClaudeAPI(query)
                setTimeout(() => {
                    respond("抱歉，目前在院內 FAQ 找不到直接解答。建議您撥打本所專線 02-XXXX-XXXX 由專人為您服務。");
                }, 1000);
            }
        }

        function respond(fullText) {
            addMessage(fullText, 'ai');
            
            // 語音策略：長篇自動摘要 (前端模擬：取前100字)
            let speechText = fullText;
            if(fullText.length > 300) {
                speechText = "這項回答內容較長，為您摘要：" + fullText.substring(0, 100) + "... 詳細內容請閱讀螢幕文字。";
            }
            
            speak(speechText);
        }

        function speak(text) {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.onstart = () => document.getElementById('stopVoiceBtn').classList.remove('hidden');
            utterance.onend = () => document.getElementById('stopVoiceBtn').classList.add('hidden');
            synth.speak(utterance);
        }

        // 事件監聽
        document.getElementById('micBtn').addEventListener('click', () => {
            if(recognition) recognition.start();
            else alert("您的瀏覽器不支援語音辨識");
        });

        document.getElementById('stopVoiceBtn').addEventListener('click', () => {
            synth.cancel();
        });

        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') handleSend();
        });

        // PWA Service Worker 註冊
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed'));
            });
        }

        window.onload = init;
    </script>
</body>
</html>
