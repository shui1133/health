<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百樂居家呼吸照護助手</title>
    <!-- PWA Support -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22百樂助手%22,%22short_name%22:%22百樂%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22}">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pulse-ring { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .chat-bubble { max-width: 85%; border-radius: 1.5rem; }
    </style>
</head>
<body class="bg-blue-50 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">百樂居家呼吸照護所</h1>
            <p class="text-xs opacity-80">智能 FAQ 查詢系統</p>
        </div>
        <button id="voice-stop-btn" onclick="stopSpeech()" class="hidden bg-red-500 p-2 rounded-full shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg>
        </button>
    </header>

    <!-- Chat Window -->
    <div id="chat-window" class="flex-grow overflow-y-auto p-4 space-y-4">
        <div class="flex justify-start">
            <div class="chat-bubble bg-white p-4 shadow-sm text-gray-800">
                您好！我是百樂小助手。您可以輸入文字，或按下方的麥克風對我說話，我會為您解答有關健保與呼吸照護的問題。
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white p-4 border-t border-gray-200">
        <div id="ai-status" class="text-xs text-blue-500 mb-2 hidden">正在搜尋最佳答案...</div>
        <div class="flex items-center space-x-2">
            <button id="mic-btn" onclick="toggleListening()" class="bg-blue-100 p-3 rounded-full text-blue-600 hover:bg-blue-200 transition">
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
            <input type="text" id="user-input" placeholder="請輸入您的問題..." class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="handleSend()" class="bg-blue-600 text-white p-3 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
            </button>
        </div>
    </div>

    <script>
        const apiKey = ""; // Gemini API 會由環境自動注入
        const GITHUB_FAQ_URL = "https://raw.githubusercontent.com/shui1133/health/main/FAQ.csv";
        
        let faqLibrary = [];
        let isListening = false;
        let lastResponse = "";
        const synth = window.speechSynthesis;

        // 同義詞對應表
        const synonyms = {
            "氧氣機": "製氧機",
            "製氧機": "氧氣機",
            "氣切": "氣管切開",
            "補助": "津貼",
            "錢": "補助"
        };

        window.onload = async () => {
            await loadFAQ();
            // PWA Service Worker 模擬
            if ('serviceWorker' in navigator) {
                console.log('PWA Ready');
            }
        };

        async function loadFAQ() {
            try {
                const res = await fetch(GITHUB_FAQ_URL);
                const text = await res.text();
                faqLibrary = text.split('\n').slice(1).filter(l => l).map(l => {
                    const parts = l.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    return {
                        category: (parts[0] || '').replace(/"/g, ''),
                        question: (parts[1] || '').replace(/"/g, ''),
                        answer: (parts[2] || '').replace(/"/g, '')
                    };
                });
            } catch (e) {
                console.error("無法載入 FAQ 離線庫");
            }
        }

        async function handleSend() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;

            addChatMessage('user', question);
            input.value = '';
            
            // 1. 本地搜尋 (包含同義詞擴充)
            let answer = searchLocalFAQ(question);

            // 2. 如果本地找不到，使用 AI
            if (!answer) {
                document.getElementById('ai-status').classList.remove('hidden');
                answer = await fetchGeminiAI(question);
                document.getElementById('ai-status').classList.add('hidden');
            }

            addChatMessage('ai', answer);
            lastResponse = answer;
            speak(answer);
        }

        function searchLocalFAQ(query) {
            let expandedQuery = query;
            for (let [key, val] of Object.entries(synonyms)) {
                if (query.includes(key)) expandedQuery += " " + val;
            }

            // 簡單關鍵字匹配
            const result = faqLibrary.find(item => 
                expandedQuery.split(' ').some(q => item.question.includes(q))
            );
            return result ? result.answer : null;
        }

        async function fetchGeminiAI(question) {
            const systemPrompt = "你是一位專業的呼吸治療師，來自『百樂居家呼吸照護所』。請用親切專業的語氣回答民眾的問題。如果問題與醫療設備補助有關，請優先建議諮詢本中心。";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: question }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "抱歉，我目前無法回答這個問題，建議您直接來電詢問專人。";
            } catch (e) {
                return "網路連線異常，請稍後再試。";
            }
        }

        function addChatMessage(role, text) {
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="chat-bubble ${role === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800'} p-4 shadow-sm">
                    ${text}
                </div>
            `;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        // 語音功能
        function speak(text) {
            stopSpeech();
            let speechText = text;
            
            // 策略：長篇回答自動摘要 (超過 300 字)
            if (text.length > 300) {
                speechText = "這是一個較長的回答，為您摘要重點：" + text.substring(0, 150) + "... 詳細內容請閱讀螢幕文字。";
            }

            const utterance = new SpeechSynthesisUtterance(speechText);
            utterance.lang = 'zh-TW';
            utterance.onstart = () => document.getElementById('voice-stop-btn').classList.remove('hidden');
            utterance.onend = () => document.getElementById('voice-stop-btn').classList.add('hidden');
            synth.speak(utterance);
        }

        function stopSpeech() {
            synth.cancel();
            document.getElementById('voice-stop-btn').classList.add('hidden');
        }

        // 語音輸入 (Speech Recognition)
        function toggleListening() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("您的瀏覽器不支援語音辨識");

            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';

            if (!isListening) {
                recognition.start();
                isListening = true;
                document.getElementById('mic-icon').classList.add('text-red-500', 'pulse-ring');
            } else {
                isListening = false;
                document.getElementById('mic-icon').classList.remove('text-red-500', 'pulse-ring');
            }

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('user-input').value = text;
                isListening = false;
                document.getElementById('mic-icon').classList.remove('text-red-500', 'pulse-ring');
                handleSend();
            };

            recognition.onerror = () => {
                isListening = false;
                document.getElementById('mic-icon').classList.remove('text-red-500', 'pulse-ring');
            };
        }
    </script>
</body>
</html>
