<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾æ¨‚å±…å®¶å‘¼å¸ç…§è­·ç³»çµ±</title>
    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22ç™¾æ¨‚å‘¼å¸%22,%22short_name%22:%22ç™¾æ¨‚%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22theme_color%22:%22#2563eb%22}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .chat-bubble { max-width: 85%; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <h1 class="text-xl font-bold">ç™¾æ¨‚å±…å®¶å‘¼å¸ç…§è­· AI æœå‹™</h1>
            <div class="flex gap-2">
                <button id="stopVoiceBtn" onclick="stopSpeaking()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-xs hidden">åœæ­¢èªéŸ³æ’­æ”¾</button>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <main id="chatWindow" class="flex-grow max-w-4xl w-full mx-auto p-4 space-y-4 overflow-y-auto pb-32">
        <div class="flex justify-start">
            <div class="bg-white border border-slate-200 p-4 rounded-2xl rounded-tl-none shadow-sm chat-bubble">
                æ‚¨å¥½ï¼Œæˆ‘æ˜¯ç™¾æ¨‚å±…å®¶å‘¼å¸ç…§è­·åŠ©ç†ã€‚æ‚¨å¯ä»¥è©¢å•é—œæ–¼ï¼šå‘¼å¸æ©Ÿè£œåŠ©ã€æ°§æ°£æ©Ÿä½¿ç”¨ã€æˆ–æ˜¯å¥ä¿ç›¸é—œå•é¡Œã€‚
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-md border-t border-slate-200">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center gap-3">
                <button id="micBtn" onclick="toggleVoiceInput()" class="w-12 h-12 bg-slate-100 hover:bg-slate-200 rounded-full flex items-center justify-center transition shrink-0">
                    <svg id="micIcon" class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </button>
                <input type="text" id="userInput" placeholder="è«‹è¼¸å…¥å•é¡Œæˆ–é»æ“Šèªªè©±..." class="flex-grow bg-slate-100 border-none rounded-2xl px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl hover:bg-blue-700 font-semibold transition">å‚³é€</button>
            </div>
            <div id="statusInfo" class="text-center text-[10px] text-slate-400 mt-2 tracking-widest uppercase">é›¢ç·šæŸ¥è©¢æ¨¡å¼å·²å•Ÿç”¨</div>
        </div>
    </footer>

    <!-- Claude API Key (Front-end temporary storage) -->
    <input type="hidden" id="claudeKey" value="">

    <script>
        const CONFIG = {
            username: 'shui1133',
            repo: 'health',
            synonyms: {
                "æ°§æ°£æ©Ÿ": ["è£½æ°§æ©Ÿ", "æ°§æ°£ç”¢ç”Ÿå™¨", "è£½æ°§å™¨"],
                "å‘¼å¸æ©Ÿ": ["å‘¼å¸è¼”åŠ©å™¨", "CPAP", "BiPAP"],
                "è£œåŠ©": ["ç”³è«‹é‡‘", "æ´¥è²¼", "é†«ç™‚è£œåŠ©"],
                "æŠ½ç—°": ["å¸ç—°", "æ¸…ç†å‘¼å¸é“"]
            }
        };

        let faqData = [];
        let synth = window.speechSynthesis;
        let recognition = null;
        let lastAnswer = "";

        // åˆå§‹åŒ–
        async function init() {
            loadFaq();
            initSpeechRecognition();
            registerServiceWorker();
        }

        async function loadFaq() {
            const url = `https://raw.githubusercontent.com/${CONFIG.username}/${CONFIG.repo}/main/FAQ.csv?t=${Date.now()}`;
            try {
                const res = await fetch(url);
                const csv = await res.text();
                Papa.parse(csv, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => { faqData = results.data; }
                });
            } catch (e) {
                console.error("ç„¡æ³•è¼‰å…¥æœ¬åœ° FAQï¼Œè«‹æª¢æŸ¥ GitHub æª”æ¡ˆè·¯å¾‘ã€‚");
            }
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    document.getElementById('micBtn').classList.add('recording-pulse', 'bg-red-50');
                    document.getElementById('micIcon').classList.add('text-red-600');
                };

                recognition.onend = () => {
                    document.getElementById('micBtn').classList.remove('recording-pulse', 'bg-red-50');
                    document.getElementById('micIcon').classList.remove('text-red-600');
                };

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('userInput').value = text;
                    sendMessage();
                };
            }
        }

        function toggleVoiceInput() {
            if (!recognition) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ã€‚");
            recognition.start();
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const query = input.value.trim();
            if (!query) return;

            addChatBubble('user', query);
            input.value = '';

            const answer = searchFaq(query);
            if (answer) {
                handleResponse(answer);
            } else {
                // å¦‚æœæœ¬åœ°æ‰¾ä¸åˆ°ï¼Œæœªä¾†å¯è§¸ç™¼ Claude API
                handleResponse("æœ¬åœ°è³‡æ–™åº«æŸ¥ç„¡æ­¤é …ï¼Œç³»çµ±æ­£åœ¨ç ”è­°ä¸­...", true);
            }
        }

        function searchFaq(query) {
            let processedQuery = query.toLowerCase();
            
            // åŒç¾©è©è™•ç†
            for (const [key, aliases] of Object.entries(CONFIG.synonyms)) {
                aliases.forEach(alias => {
                    if (processedQuery.includes(alias)) processedQuery = processedQuery.replace(alias, key);
                });
            }

            // æœå°‹é‚è¼¯
            const result = faqData.find(item => 
                (item.å•é¡Œèªªæ˜ && item.å•é¡Œèªªæ˜.toLowerCase().includes(processedQuery)) || 
                (item.ç­”æ¡ˆå…§å®¹ && item.ç­”æ¡ˆå…§å®¹.toLowerCase().includes(processedQuery))
            );

            return result ? result.ç­”æ¡ˆå…§å®¹ : null;
        }

        function handleResponse(text, isFallback = false) {
            lastAnswer = text;
            addChatBubble('bot', text);
            speakAnswer(text);
        }

        function addChatBubble(role, text) {
            const win = document.getElementById('chatWindow');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="p-4 rounded-2xl shadow-sm chat-bubble ${role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 rounded-tl-none'}">
                    ${text.replace(/\n/g, '<br>')}
                    ${role === 'bot' ? `<button onclick="speakAnswer(lastAnswer)" class="block mt-2 text-xs opacity-50 hover:opacity-100 flex items-center gap-1">ğŸ”Š é‡æ–°æœ—è®€</button>` : ''}
                </div>
            `;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        }

        function speakAnswer(text) {
            stopSpeaking();
            
            let utteranceText = text;
            // èªéŸ³ç­–ç•¥ï¼šé•·ç¯‡å›ç­”ï¼ˆè¶…é 300 å­—ï¼‰é€²è¡Œç°¡æ˜“æ‘˜è¦
            if (text.length > 300) {
                const sentences = text.split(/[ã€‚ï¼ï¼Ÿ]/);
                utteranceText = "é€™é …å›ç­”è¼ƒé•·ï¼Œç‚ºæ‚¨æ‘˜è¦å‰æ®µå…§å®¹ï¼š" + sentences.slice(0, 2).join('ã€‚') + "ã€‚å®Œæ•´å…§å®¹è«‹åƒè€ƒç•«é¢æ–‡å­—ã€‚";
            }

            const utterance = new SpeechSynthesisUtterance(utteranceText);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.1;
            
            utterance.onstart = () => document.getElementById('stopVoiceBtn').classList.remove('hidden');
            utterance.onend = () => document.getElementById('stopVoiceBtn').classList.add('hidden');

            synth.speak(utterance);
        }

        function stopSpeaking() {
            if (synth.speaking) synth.cancel();
            document.getElementById('stopVoiceBtn').classList.add('hidden');
        }

        // PWA Service Worker (ç°¡å–®æ¨¡æ“¬)
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', e => e.waitUntil(caches.open('v1').then(c => c.addAll(['./', './index.html']))));
                    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
                `;
                const blob = new Blob([swCode], {type: 'application/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(blob));
            }
        }

        window.onload = init;
    </script>
</body>
</html>
